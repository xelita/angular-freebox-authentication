/*! angular-freebox-auth 03-05-2015. Copyright xelita <admin@xelita.com> (https://github.com/xelita/angular-freebox-authentication) */
function sleepMs(a){var b=new Date,c=null;do c=new Date;while(a>c-b)}var app=angular.module("app",["fbAuthModule"]);app.controller("appCtrl",function(a,b,c){a.appToken="Ik9n1gQ4V/xZgqmSrC48pGw/WgqIQGyVGNsQLr6BJ9e3LkWkPtQGBAktzItJ5g5j",a.apiVersion=function(){c.apiVersion().then(function(b){a.apiVersion=b.data})},a.requestAuthorization=function(){var c={app_id:"fr.furiousapps.stopwifi",app_name:"StopWifi",app_version:"2.0.0",device_name:"iPhone de Benjamin"};b.requestAuthorization(c).then(function(c){a.requestAuthorization=c.data;var d=c.data.result.track_id;console.log("trackingId is: "+d);var e=c.data.result.app_token;console.log("appToken is: "+e),b.trackAuthorizationProgressUntil(d,e).then(function(b){alert("OK"),a.token=b},function(a){alert("Failed: "+a)})})},a.session=function(){b.login().then(function(c){var d=c.data.result.challenge;console.log("challenge: "+d),console.log("token: "+a.appToken),b.session("fr.furiousapps.stopwifi",a.appToken,d).then(function(b){a.sessionToken=b.data.result.session_token,console.log(a.sessionToken)})})}});var fbAuthModule=angular.module("fbAuthModule",["fbCommonModule"]);fbAuthModule.constant("fbAuthConstants",{urls:{authorize:"/login/authorize",login:"/login",session:"/login/session",logout:"/login/logout"},authorizationStatus:{unknown:"unknown",pending:"pending",timeout:"timeout",granted:"granted",denied:"denied"},tracking:{waitingTimeMillis:5e3}}),fbAuthModule.factory("fbAuthService",["$log","$http","$q","fbAuthConstants","fbCommonService",function(a,b,c,d,e){return{requestAuthorization:function(f){a.debug("fbAuthService.requestAuthorization.");var g=c.defer();return e.apiRequestUrl(d.urls.authorize).then(function(a){b({method:"POST",url:a,data:f}).then(function(a){g.resolve(a)})}),g.promise},trackAuthorizationProgress:function(f){a.debug("fbAuthService.trackAuthorizationProgress.");var g=c.defer();return e.apiRequestUrl(d.urls.authorize+"/"+f).then(function(a){b({method:"GET",url:a}).then(function(a){g.resolve(a)})}),g.promise},trackAuthorizationProgressUntil:function(b,e){a.debug("fbAuthService.trackAuthorizationProgressUntil.");var f=this,g=c.defer(),h=function(c){var g=d.tracking.waitingTimeMillis||5e3;f.trackAuthorizationProgress(b).then(function(b){var d=b.data.result.status;switch(d){case"granted":a.debug(d),c.resolve(e);break;case"denied":a.debug(d),c.reject(d);break;case"timeout":a.debug(d),c.reject(d);break;default:a.debug(d),c.notify(d),sleepMs(g),h(c)}})};return h(g),g.promise},login:function(f){a.debug("fbAuthService.login.");var g=c.defer();return e.apiRequestUrl(d.urls.login,f).then(function(a){b({method:"GET",url:a}).then(function(a){g.resolve(a)})}),g.promise},session:function(f,g,h,i){a.debug("fbAuthService.session.");var j=c.defer(),k=CryptoJS.HmacSHA1(h,g).toString();return console.log(k),e.apiRequestUrl(d.urls.session,i).then(function(a){b({method:"POST",url:a,data:{app_id:f,password:k}}).then(function(a){j.resolve(a)})}),j.promise},logout:function(f){a.debug("fbAuthService.logout.");var g=c.defer();return e.apiRequestUrl(d.urls.logout,f).then(function(a){b({method:"POST",url:a}).then(function(a){g.resolve(a)})}),g.promise}}}]);